def writeVersionFile(version) {
    File f = file("gradle.properties")
    String s = f.getText().replaceFirst(/openApiGeneratorVersion=.*/, "openApiGeneratorVersion=${version}")
    f.setText(s)
}

task setReleaseVersion {
    doFirst {
        def matcherWithBN = version =~ /^(\d+)\.(\d+)\.(\d+)-(\d+)-SNAPSHOT$/
        def major, minor, patch, buildNumber
        if (matcherWithBN.matches()) {
            (major, minor, patch, buildNumber) = matcher[0][1..4].collect { v -> v as Integer}
        } else {
            def matcherWithoutBN = version =~ /^(\d+)\.(\d+)\.(\d+)-SNAPSHOT$/
            (major, minor, patch) = matcherWithoutBN[0][1..3].collect { v -> v as Integer}
            buildNumber = 0
            assert matcherWithoutBN.matches(), "Invalid version: ${version}"
        }
        // set new version
        version = "${major}.${minor}.${patch}-${buildNumber}"
        writeVersionFile(version)
    }
}

task setDevelopmentVersion {
    doFirst {
        def matcher = version =~ /^(\d+)\.(\d+)\.(\d+)-(\d+)$/
        assert matcher.matches(), "Invalid version: ${version}"
        def (major, minor, patch, buildNumber) = matcher[0][1..4].collect { v -> v as Integer}
        // set new version
        version = "${major}.${minor}.${patch}-${buildNumber + 1}-SNAPSHOT"
        writeVersionFile(version)
    }
}

// Prepare for release.
// - set release version & tag
// - build
// - push
task prepareRelease {
    dependsOn setReleaseVersion, build
    doFirst {
        def tag = "v${version}"
        exec { commandLine "git", "push", "origin", "HEAD" }
        exec { commandLine "git", "push", "origin", "${tag}" }
    }
}

// Perform release.
// - publish
// - set next development version
// - push
task performRelease {
    dependsOn publish, setDevelopmentVersion
    doFirst {
        exec { commandLine "git", "push", "origin", "HEAD" }
    }
}
